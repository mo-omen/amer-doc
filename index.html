<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to JPG Converter (GDRFA Spec)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js library from Mozilla -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            color: #1f2937; /* Tailwind gray-800 */
        }
        [lang="ar"] body, [lang="ar"] h1, [lang="ar"] h2, [lang="ar"] h3, [lang="ar"] p, [lang="ar"] button, [lang="ar"] label, [lang="ar"] option, [lang="ar"] select {
            font-family: 'Tajawal', sans-serif;
        }
        .main-container {
             animation: fadeIn 0.8s ease-out;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px) saturate(150%);
            -webkit-backdrop-filter: blur(15px) saturate(150%);
            border-radius: 1rem;
            border: 1px solid rgba(209, 213, 219, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.15);
        }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .btn-secondary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-zip { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .btn-clear { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }
        .output-card {
            border: 1px solid #e5e7eb; /* gray-200 */
            transition: transform 0.3s, box-shadow 0.3s;
            animation: cardFadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        .output-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .unified-footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(209, 213, 219, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #6b7280; /* Tailwind gray-500 */
        }
        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 700;
            color: #4b5563; /* Tailwind gray-600 */
            text-decoration: none;
            transition: color 0.3s ease;
            animation: glow 3.5s ease-in-out infinite;
        }
        .github-link:hover {
            color: #3b82f6; /* Tailwind blue-500 */
        }
        .github-link svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        #help-modal { transition: opacity 0.3s ease; }
        #modal-content { transition: transform 0.3s ease; }
        .modal-enter { opacity: 0; }
        .modal-leave-active { opacity: 0; }
        .modal-content-enter { transform: scale(0.95); }
        .modal-content-leave-active { transform: scale(0.95); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes cardFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes glow {
            0%, 100% {
                text-shadow: 0 0 4px rgba(59, 130, 246, 0.5);
                color: #4b5563;
            }
            50% {
                text-shadow: 0 0 12px rgba(59, 130, 246, 0.9);
                color: #3b82f6;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8 overflow-y-auto">
    <div class="absolute top-4 flex items-center gap-4 z-10 ltr:right-4 rtl:left-4">
        <button id="lang-toggle" class="text-gray-600 hover:text-blue-500 font-semibold py-2 px-4 rounded-lg bg-white/60 backdrop-blur-sm shadow-sm transition-colors border border-white/30">العربية</button>
        <button id="help-button" class="w-10 h-10 flex items-center justify-center bg-white/60 backdrop-blur-sm rounded-full shadow-sm text-blue-500 hover:bg-blue-100 text-xl font-bold transition-colors border border-white/30">?</button>
    </div>

    <div class="main-container w-full max-w-2xl p-6 sm:p-8 glass-effect relative">
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800" data-lang-key="mainTitle">PDF to JPG Converter</h1>
            <p class="text-gray-600 mt-2" data-lang-key="subTitle">Convert PDF pages to high-quality JPGs compliant with GDRFA specifications.</p>
        </div>

        <div class="bg-white/70 rounded-lg p-6 space-y-6">
            <!-- File Input Section -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="step1Label">1. Choose PDF or ZIP files:</label>
                <div class="flex items-center justify-center w-full">
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                            <p class="mb-2 text-sm text-gray-500"><span class="font-semibold" data-lang-key="clickToUpload">Click to upload</span><span data-lang-key="orDragAndDrop"> or drag and drop</span></p>
                            <p class="text-xs text-gray-500" data-lang-key="fileTypes">PDF or ZIP files containing PDFs/Images</p>
                        </div>
                        <input id="fileInput" type="file" class="hidden" accept="application/pdf,application/zip,application/x-zip-compressed" multiple>
                    </label>
                </div>
                <p id="fileName" class="text-center text-sm text-gray-500 mt-2 h-5"></p>
            </div>
            
            <!-- Width Selector Section -->
            <div>
                <label for="widthSelector" class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="step2Label">2. Select output width (pixels):</label>
                <select id="widthSelector" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                    <option value="600">600px</option><option value="700">700px</option><option value="800">800px</option><option value="900">900px</option><option value="1000">1000px</option><option value="1100">1100px</option><option value="1200" selected>1200px</option>
                </select>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="convertButton" class="btn btn-primary w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg class="w-5 h-5 ltr:mr-2 rtl:ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.696V7.721c0-2.616-2.12-4.736-4.736-4.736H7.721C5.105 3 3 5.12 3 7.721v4.922" /></svg>
                    <span data-lang-key="convertBtn">Convert to JPG</span>
                </button>
                <button id="clearButton" class="btn btn-clear w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg class="w-5 h-5 ltr:mr-2 rtl:ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    <span data-lang-key="clearBtn">Clear</span>
                </button>
                <button id="downloadAllButton" class="btn btn-zip sm:col-span-2 w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center hidden">
                     <svg class="w-5 h-5 ltr:mr-2 rtl:ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.03 1.125 0 1.131.094 1.976 1.057 1.976 2.192V7.5M12 14.25m-2.625 0a2.625 2.625 0 115.25 0 2.625 2.625 0 01-5.25 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.975 11.25H8.025a.75.75 0 000 1.5h7.95a.75.75 0 000-1.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6h.008v.008H6.75V6zM6.75 9h.008v.008H6.75V9zM6.75 12h.008v.008H6.75V12zM9 6h.008v.008H9V6zM9 9h.008v.008H9V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 9a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0112 9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5a1.5 1.5 0 011.5 1.5v9a1.5 1.5 0 01-1.5-1.5H3.75a1.5 1.5 0 01-1.5-1.5v-9a1.5 1.5 0 011.5-1.5z" /></svg>
                    <span data-lang-key="downloadAllBtn">Download All as ZIP</span>
                </button>
            </div>
        </div>
        
        <!-- Status/Message Area -->
        <div id="status" class="text-center mt-6 h-10 flex items-center justify-center"></div>

        <!-- Developer Credit Footer -->
        <footer class="unified-footer">
            <span data-lang-key="developedBy">Developed by</span>
            <a href="https://github.com/mo-omen" target="_blank" rel="noopener noreferrer" class="github-link">
                <svg viewBox="0 0 16 16" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
                <span>Momen Elhag</span>
            </a>
        </footer>
    </div>

    <!-- Output Section -->
    <div id="output" class="w-full max-w-6xl mt-8 flex flex-col space-y-8"></div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="glass-effect p-6 max-w-2xl w-full relative">
            <button id="close-modal-button" class="absolute top-3 text-2xl font-bold text-gray-500 hover:text-gray-800 ltr:right-3 rtl:left-3">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800" data-lang-key="howToUseTitle">How to Use</h2>
            <div class="space-y-4 text-gray-700 max-h-[70vh] overflow-y-auto ltr:pr-2 rtl:pl-2">
                <div><h3 class="font-bold" data-lang-key="step1Title">1. Select Files</h3><p data-lang-key="step1Desc">Click the 'Click to upload' button or drag and drop your files into the dashed box. You can select multiple PDF files, ZIP files, or a mix of both. The application will automatically find and process all PDF files inside any selected ZIP archives.</p></div>
                <div><h3 class="font-bold" data-lang-key="step2Title">2. Choose Width</h3><p data-lang-key="step2Desc">Select the desired width for the output JPG images from the dropdown menu. The height will be adjusted automatically to maintain the aspect ratio. The image quality will be adjusted to keep the file size below 512 KB, as required by GDRFA.</p></div>
                <div><h3 class="font-bold" data-lang-key="step3Title">3. Convert</h3><p data-lang-key="step3Desc">Click the 'Convert to JPG' button. The application will process each page of your PDF files and display them as individual JPG images. Any other images found in ZIP files will also be displayed.</p></div>
                <div><h3 class="font-bold" data-lang-key="step4Title">4. Download</h3><p data-lang-key="step4Desc">You can download each image individually using the 'Download JPG' button on each card. Alternatively, click the 'Download All as ZIP' button at the top to save all the generated images in a single ZIP file.</p></div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Element References
            const fileInput = document.getElementById('fileInput');
            const fileNameDisplay = document.getElementById('fileName');
            const widthSelector = document.getElementById('widthSelector');
            const convertButton = document.getElementById('convertButton');
            const clearButton = document.getElementById('clearButton');
            const downloadAllButton = document.getElementById('downloadAllButton');
            const statusDiv = document.getElementById('status');
            const outputDiv = document.getElementById('output');
            const dropZone = document.querySelector('label.border-dashed');
            const langToggleButton = document.getElementById('lang-toggle');
            const helpButton = document.getElementById('help-button');
            const helpModal = document.getElementById('help-modal');
            const modalContent = document.getElementById('modal-content');
            const closeModalButton = document.getElementById('close-modal-button');

            // Set PDF.js worker source
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
            
            // App State
            let allGeneratedFiles = [];
            let otherImageFiles = [];
            let currentLang = 'en';

            // --- Translations ---
            const translations = {
                en: {
                    mainTitle: 'PDF to JPG Converter',
                    subTitle: 'Convert PDF pages to high-quality JPGs compliant with GDRFA specifications.',
                    step1Label: '1. Choose PDF or ZIP files:',
                    clickToUpload: 'Click to upload',
                    orDragAndDrop: ' or drag and drop',
                    fileTypes: 'PDF or ZIP files containing PDFs/Images',
                    step2Label: '2. Select output width (pixels):',
                    convertBtn: 'Convert to JPG',
                    clearBtn: 'Clear',
                    downloadAllBtn: 'Download All as ZIP',
                    developedBy: 'Developed by',
                    howToUseTitle: 'How to Use',
                    step1Title: '1. Select Files',
                    step1Desc: "Click the 'Click to upload' button or drag and drop your files into the dashed box. You can select multiple PDF files, ZIP files, or a mix of both. The application will automatically find and process all PDF files inside any selected ZIP archives.",
                    step2Title: '2. Choose Width',
                    step2Desc: 'Select the desired width for the output JPG images from the dropdown menu. The height will be adjusted automatically to maintain the aspect ratio. The image quality will be adjusted to keep the file size below 512 KB, as required by GDRFA.',
                    step3Title: '3. Convert',
                    step3Desc: "Click the 'Convert to JPG' button. The application will process each page of your PDF files and display them as individual JPG images. Any other images found in ZIP files will also be displayed.",
                    step4Title: '4. Download',
                    step4Desc: "You can download each image individually using the 'Download JPG' button on each card. Alternatively, click the 'Download All as ZIP' button at the top to save all the generated images in a single ZIP file.",
                    filesSelected: 'file(s) selected',
                    processing: 'Starting processing for',
                    readingPDF: 'Reading PDF file:',
                    inspectingZIP: 'Inspecting ZIP file:',
                    unsupportedFile: 'Skipping unsupported file type:',
                    processingComplete: 'Processing complete.',
                    pagesConverted: 'page(s) converted.',
                    otherImagesFound: 'other image(s) found.',
                    noFilesConverted: 'No PDF pages converted or images found in the selection.',
                    selectFilesError: 'Please select one or more PDF or ZIP files first.',
                    zipError: 'Failed to process',
                    zipErrorDetail: '. Is it a valid ZIP file?',
                    pdfError: 'Failed to process',
                    pdfErrorDetail: '. Error:',
                    creatingZIP: 'Creating ZIP file...',
                    zipSuccess: 'ZIP file downloaded successfully!',
                    zipCreationError: 'Error creating ZIP file.',
                    convertingPage: 'Converting page',
                    of: 'of',
                    for: 'for',
                    page: 'Page',
                    size: 'Size:',
                    quality: 'Quality:',
                    downloadJPG: 'Download JPG',
                    download: 'Download',
                    otherImagesTitle: 'Other Image Files Found',
                    convertedFrom: 'Converted Pages from:'
                },
                ar: {
                    mainTitle: 'محول PDF إلى JPG',
                    subTitle: 'حوّل صفحات PDF إلى صور JPG عالية الجودة متوافقة مع مواصفات GDRFA.',
                    step1Label: '١. اختر ملفات PDF أو ZIP:',
                    clickToUpload: 'انقر للتحميل',
                    orDragAndDrop: ' أو اسحب وأفلت',
                    fileTypes: 'ملفات PDF أو ZIP تحتوي على ملفات PDF/صور',
                    step2Label: '٢. حدد عرض الصورة (بكسل):',
                    convertBtn: 'تحويل إلى JPG',
                    clearBtn: 'مسح',
                    downloadAllBtn: 'تنزيل الكل كملف ZIP',
                    developedBy: 'تم التطوير بواسطة',
                    howToUseTitle: 'كيفية الاستخدام',
                    step1Title: '١. تحديد الملفات',
                    step1Desc: "انقر على زر 'انقر للتحميل' أو قم بسحب وإفلات ملفاتك في المربع المتقطع. يمكنك تحديد عدة ملفات PDF أو ملفات ZIP أو مزيج من الاثنين. سيقوم التطبيق تلقائيًا بالعثور على جميع ملفات PDF ومعالجتها داخل أي أرشيف ZIP محدد.",
                    step2Title: '٢. اختيار العرض',
                    step2Desc: 'حدد العرض المطلوب لصور JPG الناتجة من القائمة المنسدلة. سيتم تعديل الارتفاع تلقائيًا للحفاظ على نسبة العرض إلى الارتفاع. سيتم تعديل جودة الصورة للحفاظ على حجم الملف أقل من 512 كيلوبايت، كما هو مطلوب من قبل GDRFA.',
                    step3Title: '٣. التحويل',
                    step3Desc: "انقر على زر 'تحويل إلى JPG'. سيقوم التطبيق بمعالجة كل صفحة من ملفات PDF الخاصة بك وعرضها كصور JPG فردية. سيتم أيضًا عرض أي صور أخرى تم العثور عليها في ملفات ZIP.",
                    step4Title: '٤. التنزيل',
                    step4Desc: "يمكنك تنزيل كل صورة على حدة باستخدام زر 'تنزيل JPG' الموجود على كل بطاقة. بدلاً من ذلك ، انقر فوق الزر 'تنزيل الكل كملف ZIP' في الأعلى لحفظ جميع الصور التي تم إنشاؤها في ملف ZIP واحد.",
                    filesSelected: 'ملف (ملفات) محددة',
                    processing: 'بدء معالجة',
                    readingPDF: 'قراءة ملف PDF:',
                    inspectingZIP: 'فحص ملف ZIP:',
                    unsupportedFile: 'تجاوز نوع ملف غير مدعوم:',
                    processingComplete: 'اكتملت المعالجة.',
                    pagesConverted: 'صفحة (صفحات) تم تحويلها.',
                    otherImagesFound: 'صورة (صور) أخرى تم العثور عليها.',
                    noFilesConverted: 'لم يتم تحويل أي صفحات PDF أو العثور على صور في التحديد.',
                    selectFilesError: 'الرجاء تحديد ملف PDF أو ZIP واحد أو أكثر أولاً.',
                    zipError: 'فشل في معالجة',
                    zipErrorDetail: '. هل هو ملف ZIP صالح؟',
                    pdfError: 'فشل في معالجة',
                    pdfErrorDetail: '. خطأ:',
                    creatingZIP: 'جاري إنشاء ملف ZIP...',
                    zipSuccess: 'تم تنزيل ملف ZIP بنجاح!',
                    zipCreationError: 'خطأ في إنشاء ملف ZIP.',
                    convertingPage: 'جاري تحويل الصفحة',
                    of: 'من',
                    for: 'لـ',
                    page: 'صفحة',
                    size: 'الحجم:',
                    quality: 'الجودة:',
                    downloadJPG: 'تنزيل JPG',
                    download: 'تنزيل',
                    otherImagesTitle: 'ملفات صور أخرى تم العثور عليها',
                    convertedFrom: 'صفحات محولة من:'
                }
            };

            // --- Language Functions ---
            const setLanguage = (lang) => {
                currentLang = lang;
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.getAttribute('data-lang-key');
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });

                langToggleButton.textContent = lang === 'en' ? 'العربية' : 'English';
            };

            langToggleButton.addEventListener('click', () => {
                const newLang = currentLang === 'en' ? 'ar' : 'en';
                setLanguage(newLang);
            });

            // --- Modal Functions ---
            const showModal = () => {
                helpModal.style.display = 'flex';
                setTimeout(() => {
                    helpModal.classList.remove('modal-enter');
                    modalContent.classList.remove('modal-content-enter');
                }, 10);
            };
            const hideModal = () => {
                helpModal.classList.add('modal-leave-active');
                modalContent.classList.add('modal-content-leave-active');
                setTimeout(() => {
                    helpModal.style.display = 'none';
                    helpModal.classList.remove('modal-leave-active');
                    modalContent.classList.remove('modal-content-leave-active');
                }, 300);
            };

            helpButton.addEventListener('click', showModal);
            closeModalButton.addEventListener('click', hideModal);
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) hideModal();
            });

            // --- Drag and Drop ---
            let dragCounter = 0;
            document.body.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); });
            document.body.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); });
            dropZone.addEventListener('dragenter', (e) => { e.preventDefault(); e.stopPropagation(); dragCounter++; dropZone.classList.add('bg-blue-100', 'border-blue-400'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dragCounter--; if (dragCounter === 0) { dropZone.classList.remove('bg-blue-100', 'border-blue-400'); } });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter = 0;
                dropZone.classList.remove('bg-blue-100', 'border-blue-400');
                const droppedFiles = e.dataTransfer.files;
                if (droppedFiles.length > 0) {
                    fileInput.files = droppedFiles;
                    handleFileSelection();
                }
            });

            // --- Core App Logic ---
            fileInput.addEventListener('change', handleFileSelection);
            convertButton.addEventListener('click', handleConversion);
            clearButton.addEventListener('click', resetUI);
            downloadAllButton.addEventListener('click', downloadAllFilesAsZip);
            
            function handleFileSelection() {
                const numFiles = fileInput.files.length;
                if (numFiles > 0) {
                    fileNameDisplay.textContent = `${numFiles} ${translations[currentLang].filesSelected}`;
                    convertButton.disabled = false;
                    clearButton.disabled = false;
                } else {
                    resetUI();
                }
            }
            
            async function handleConversion() {
                const files = fileInput.files;
                if (files.length === 0) {
                    showStatus(translations[currentLang].selectFilesError, 'error');
                    return;
                }
                resetOutput();
                convertButton.disabled = true;
                clearButton.disabled = true;
                showLoadingSpinner(`${translations[currentLang].processing} ${files.length} ${translations[currentLang].filesSelected}...`);
                for (const file of files) {
                    const fileType = file.type;
                    const fileName = file.name;
                    if (fileType === 'application/pdf') {
                        showLoadingSpinner(`${translations[currentLang].readingPDF} ${fileName}`);
                        const pdfData = await readFileAsArrayBuffer(file);
                        await processPdfData(pdfData, fileName);
                    } else if (fileType === 'application/zip' || fileType === 'application/x-zip-compressed' || fileName.toLowerCase().endsWith('.zip')) {
                        showLoadingSpinner(`${translations[currentLang].inspectingZIP} ${fileName}`);
                        try {
                            const zip = await JSZip.loadAsync(file);
                            const filePromises = [];
                            zip.forEach((relativePath, zipEntry) => {
                                if (zipEntry.dir) return;
                                const entryName = zipEntry.name;
                                const lowerCaseName = entryName.toLowerCase();
                                if (lowerCaseName.endsWith('.pdf')) {
                                    filePromises.push(zipEntry.async('arraybuffer').then(pdfData => processPdfData(pdfData, entryName)));
                                } else if (/\.(jpe?g|png|gif|bmp|webp)$/i.test(lowerCaseName)) {
                                     filePromises.push(zipEntry.async('blob').then(imageBlob => {
                                        const lastDotIndex = entryName.lastIndexOf('.');
                                        const namePart = lastDotIndex !== -1 ? entryName.substring(0, lastDotIndex) : entryName;
                                        const extensionPart = lastDotIndex !== -1 ? entryName.substring(lastDotIndex) : '';
                                        const sanitizedNamePart = namePart.replace(/[^a-zA-Z0-9- ]/g, '');
                                        const finalFileName = sanitizedNamePart + extensionPart;
                                        otherImageFiles.push({ name: finalFileName, blob: imageBlob });
                                    }));
                                }
                            });
                            await Promise.all(filePromises);
                        } catch (error) {
                            console.error(`Error processing ZIP ${fileName}:`, error);
                            displayErrorCard(outputDiv, `${translations[currentLang].zipError} ${fileName}${translations[currentLang].zipErrorDetail}`);
                        }
                    } else {
                        console.warn(`${translations[currentLang].unsupportedFile} ${fileName} (${fileType})`);
                    }
                }
                displayOtherImageFiles();
                let statusMessage = '';
                const convertedCount = allGeneratedFiles.length;
                const otherCount = otherImageFiles.length;
                if (convertedCount > 0 || otherCount > 0) {
                    statusMessage = `${translations[currentLang].processingComplete} `;
                    if (convertedCount > 0) statusMessage += `${convertedCount} ${translations[currentLang].pagesConverted} `;
                    if (otherCount > 0) statusMessage += `${otherCount} ${translations[currentLang].otherImagesFound}`;
                    showStatus(statusMessage, 'success');
                    downloadAllButton.classList.remove('hidden');
                } else {
                    showStatus(translations[currentLang].noFilesConverted, 'error');
                }
                clearButton.disabled = false;
            }
            
            async function processPdfData(pdfData, fileName) {
                const originalFileName = fileName.replace(/\.pdf$/i, '').replace(/[^a-zA-Z0-9- ]/g, '');
                const resultSection = document.createElement('div');
                resultSection.className = 'w-full';
                const header = document.createElement('h2');
                header.className = 'text-xl font-bold text-gray-700 mb-4 border-b pb-2';
                header.textContent = `${translations[currentLang].convertedFrom} ${fileName}`;
                resultSection.appendChild(header);
                const pagesGrid = document.createElement('div');
                pagesGrid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';
                resultSection.appendChild(pagesGrid);
                outputDiv.appendChild(resultSection);
                try {
                    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    const numPages = pdf.numPages;
                    for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                        showLoadingSpinner(`${translations[currentLang].convertingPage} ${pageNum} ${translations[currentLang].of} ${numPages} ${translations[currentLang].for} ${fileName}...`);
                        const page = await pdf.getPage(pageNum);
                        const canvas = await renderPageToCanvas(page);
                        const { jpgBlob, quality } = await compressCanvasToJpg(canvas);
                        const jpgDataUrl = URL.createObjectURL(jpgBlob);
                        const jpgFilename = `${originalFileName}_page_${pageNum}.jpg`;
                        allGeneratedFiles.push({ name: jpgFilename, blob: jpgBlob });
                        displayConvertedImageCard(pagesGrid, jpgDataUrl, pageNum, jpgBlob.size, quality, jpgFilename);
                    }
                } catch (error) {
                    console.error(`Error processing ${fileName}:`, error);
                    displayErrorCard(resultSection, `${translations[currentLang].pdfError} ${fileName}${translations[currentLang].pdfErrorDetail} ${error.message}`);
                }
            }

            function displayOtherImageFiles() {
                if (otherImageFiles.length === 0) return;
                const otherFilesSection = document.createElement('div');
                otherFilesSection.className = 'w-full';
                const header = document.createElement('h2');
                header.className = 'text-xl font-bold text-gray-700 mb-4 border-b pb-2';
                header.textContent = translations[currentLang].otherImagesTitle;
                otherFilesSection.appendChild(header);
                const imagesGrid = document.createElement('div');
                imagesGrid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';
                otherFilesSection.appendChild(imagesGrid);
                outputDiv.appendChild(otherFilesSection);
                otherImageFiles.forEach(file => {
                    const dataUrl = URL.createObjectURL(file.blob);
                    displayOtherImageCard(imagesGrid, dataUrl, file.name, file.blob.size);
                });
            }

            async function downloadAllFilesAsZip() {
                showLoadingSpinner(translations[currentLang].creatingZIP);
                const zip = new JSZip();
                allGeneratedFiles.forEach(file => zip.file(file.name, file.blob));
                otherImageFiles.forEach(file => zip.file(file.name, file.blob));
                try {
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = 'converted_and_other_images.zip';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showStatus(translations[currentLang].zipSuccess, 'success');
                } catch (error) {
                    console.error('Error creating ZIP file:', error);
                    showStatus(translations[currentLang].zipCreationError, 'error');
                }
            }

            function readFileAsArrayBuffer(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = () => reject(reader.error); reader.readAsArrayBuffer(file); }); }
            async function renderPageToCanvas(page) {
                const TARGET_WIDTH = parseInt(widthSelector.value, 10);
                const viewportDefault = page.getViewport({ scale: 1 });
                const scale = TARGET_WIDTH / viewportDefault.width;
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height; canvas.width = viewport.width;
                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                return canvas;
            }
            async function compressCanvasToJpg(canvas) {
                const MAX_SIZE_BYTES = 512 * 1024; let quality = 1.0; let jpgBlob;
                while (quality > 0.1) {
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    jpgBlob = await (await fetch(dataUrl)).blob();
                    if (jpgBlob.size <= MAX_SIZE_BYTES) { return { jpgBlob, quality: Math.round(quality * 100) }; }
                    quality -= 0.05;
                }
                console.warn('Could not compress image under 512KB, even at lowest quality.');
                return { jpgBlob, quality: 10 };
            }

            function displayConvertedImageCard(parentElement, dataUrl, pageNum, sizeBytes, quality, downloadName) {
                const sizeKB = (sizeBytes / 1024).toFixed(2);
                const card = document.createElement('div');
                card.className = 'output-card bg-white rounded-lg shadow-md p-4 flex flex-col items-center text-center';
                card.style.animationDelay = `${(parentElement.children.length % 4) * 100}ms`;
                card.innerHTML = `
                    <img src="${dataUrl}" alt="${translations[currentLang].page} ${pageNum}" class="w-full h-auto rounded-md border border-gray-200 mb-4 object-contain" style="max-height: 300px;">
                    <h3 class="font-bold text-lg text-gray-800">${translations[currentLang].page} ${pageNum}</h3>
                    <p class="text-sm text-gray-500 mb-4">${translations[currentLang].size} <span class="font-semibold text-green-600">${sizeKB} KB</span> | ${translations[currentLang].quality} ${quality}%</p>
                    <a href="${dataUrl}" download="${downloadName}" class="btn btn-secondary w-full text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 ltr:mr-2 rtl:ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span data-lang-key="downloadJPG">${translations[currentLang].downloadJPG}</span>
                    </a>`;
                parentElement.appendChild(card);
            }

            function displayOtherImageCard(parentElement, dataUrl, fileName, sizeBytes) {
                const sizeKB = (sizeBytes / 1024).toFixed(2);
                const card = document.createElement('div');
                card.className = 'output-card bg-white rounded-lg shadow-md p-4 flex flex-col items-center text-center';
                card.style.animationDelay = `${(parentElement.children.length % 4) * 100}ms`;
                card.innerHTML = `
                    <img src="${dataUrl}" alt="${fileName}" class="w-full h-auto rounded-md border border-gray-200 mb-4 object-contain" style="max-height: 300px;">
                    <h3 class="font-bold text-sm text-gray-800 truncate w-full" title="${fileName}">${fileName}</h3>
                    <p class="text-sm text-gray-500 mb-4">${translations[currentLang].size} <span class="font-semibold">${sizeKB} KB</span></p>
                    <a href="${dataUrl}" download="${fileName}" class="btn btn-secondary w-full text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 ltr:mr-2 rtl:ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span data-lang-key="download">${translations[currentLang].download}</span>
                    </a>`;
                parentElement.appendChild(card);
            }

            function displayErrorCard(parentElement, message) { const errorCard = document.createElement('div'); errorCard.className = 'w-full bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative'; errorCard.textContent = message; parentElement.appendChild(errorCard); }
            function showStatus(message, type = 'info') { statusDiv.innerHTML = ''; const p = document.createElement('p'); p.textContent = message; p.className = type === 'error' ? 'text-red-600 font-semibold' : (type === 'success' ? 'text-green-600 font-semibold' : 'text-blue-600'); statusDiv.appendChild(p); }
            function showLoadingSpinner(message) { statusDiv.innerHTML = `<div class="flex items-center justify-center"><div class="spinner ltr:mr-3 rtl:ml-3"></div><p class="text-blue-600">${message}</p></div>`; }
            function resetOutput() { outputDiv.innerHTML = ''; downloadAllButton.classList.add('hidden'); allGeneratedFiles = []; otherImageFiles = []; }
            function resetUI() { statusDiv.innerHTML = ''; fileNameDisplay.textContent = ''; convertButton.disabled = true; clearButton.disabled = true; fileInput.value = ''; resetOutput(); }
            
            // Initial language set
            setLanguage('en');
        });
    </script>
</body>
</html>
